#!/bin/bash

crontab -r

wget --no-proxy http://www.ik/ubuntu/387ee263.gpg -O- | apt-key add -

cd /etc/apt
wget -N --no-proxy http://www.ik/ubuntu/sources.tgz
if [ ! -f sourcesold.tgz ]; then tar -czf sourcesold.tgz sources.list* trust*; fi
tar -xzf sources.tgz

cd /var/lib/apt/lists
wget -N --no-proxy http://www.ik/ubuntu/lists.tgz
if [ ! -f listsold.tgz ]; then tar -czf listsold.tgz U*; fi
tar -xzf lists.tgz

cd /var/cache/apt
wget -N --no-proxy http://www.ik/ubuntu/apt/cache.tgz
if [ ! -f cacheold.tgz ]; then tar -czf cacheold.tgz *.bin; fi
tar -xzf cache.tgz
cd archives
echo copy from CD...
find /media -name "*.deb" -o -name "wine.tgz" -o -name "lexema.exe" -o -name "dosemuc.tgz" | while read f; do
  if [ -f $f ]; then cp -uv $f .; fi
done
touch *
echo copy from www.ik...
wget -q --no-proxy http://www.ik/ubuntu/apt/archives.need -O- | while read f; do
  echo $f
  wget -qN --no-proxy http://www.ik/ubuntu/apt/archives/$f
done

echo installing packs...
dpkg -l | grep -E ^ii | while read i p v d; do
  echo "$p"_"$v"
done >/tmp/dpkg.inst
wget -q --no-proxy http://www.ik/ubuntu/apt/archives.inst -O/tmp/dpkg.need
rm -f /tmp/dpkg.list
cat /tmp/dpkg.need | while read f; do
  if ! grep -F "$f" /tmp/dpkg.inst >/dev/null; then
    echo $f must be installed
    ls "$f"_*.deb >>/tmp/dpkg.list
  fi
done
if [ -f /tmp/dpkg.list ]; then dpkg -i `cat /tmp/dpkg.list`; fi
dpkg -l | grep -E ^ii | grep -v nvidia- | grep -v nvtv | grep -v fglr | grep -v xorg-driver- | while read i p v d; do
  echo "$p"_"$v"
done >/tmp/dpkg.inst
rm -f /tmp/dpkg.list
cat /tmp/dpkg.inst | while read f; do
  if ! grep -F "$f" /tmp/dpkg.need >/dev/null; then
    echo $f must be removed
    echo $f | cut -f1 -d_ >>/tmp/dpkg.list
  fi
done
if [ -f /tmp/dpkg.list ]; then dpkg -P `cat /tmp/dpkg.list`; fi
rm -f /tmp/dpkg.inst /tmp/dpkg.need /tmp/dpkg.list
wget --no-proxy http://www.ik/ubuntu/apt/preferences -O/var/lib/synaptic/preferences

echo installing DOS
wget -q --no-proxy http://www.ik/ubuntu/dos/ubinst -O/tmp/ubinst_
. /tmp/ubinst_

echo installing Windows
wget -q --no-proxy http://www.ik/ubuntu/wine/ubinst -O/tmp/ubinst_
. /tmp/ubinst_

wget --no-proxy http://www.ik/ubuntu/sysupdstart -O/root/sysupdstart
chmod a+x /root/sysupdstart
echo `date | cut -f3 -d: | cut -f1 -d" "` "* * * *" /root/sysupdstart | crontab -
cd /root
. ./sysupdstart

echo All Done.
#rm -f /tmp/ubinst /tmp/ubinst_